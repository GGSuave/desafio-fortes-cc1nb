<!DOCTYPE html>
<html lang="pt-br">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0"
		/>
		<title>Novo Evento - Fortes</title>
		<link rel="stylesheet" href="./../style/main.css" />
		<link rel="stylesheet" href="./style/cadastro.css" />
		<link
			rel="shortcut icon"
			href="../img/logo/logo.png"
			type="image/x-icon"
		/>
	</head>
	<body>
		<div class="page-wrapper">
			<header class="main-header">
				<div class="header-content-wrapper">
					<div class="header-left">
						<button
							class="icon-button back-button"
							aria-label="Voltar"
							onclick="voltar()"
						>
							<img
								src="./../img/icon/arrow-left.svg"
								alt="Seta para voltar"
								class="icon"
							/>
						</button>
						<div>
							<h1 class="header-title">
								Novo Evento
							</h1>
							<p class="header-description">
								Cadastre um novo evento e
								solicite coleta
							</p>
						</div>
					</div>
					<div class="header-right">
						<button
							class="button button-outline"
							id="saveDraftBtn"
							onclick="salvarRascunho()"
						>
							Salvar Rascunho
						</button>
						<button
							class="button button-primary"
							id="publishEventBtn"
							onclick="salvarEvento()"
						>
							<img
								src="./../img/icon/save.svg"
								alt="Salvar"
								class="icon-sm icon-white"
							/>
							Publicar Evento
						</button>
					</div>
				</div>
			</header>

			<div class="container main-content-area">
				<div class="form-layout">
					<div class="form-main-section">
						<div class="card">
							<div class="card-header">
								<h2 class="card-title">
									<img
										src="./../img/icon/calendr.svg"
										alt="Calendário"
										class="icon icon-green"
									/>
									Informações Básicas
								</h2>
								<p class="card-description">
									Dados principais do evento
								</p>
							</div>
							<div class="card-content space-y-4">
								<div class="grid-2-cols gap-4">
									<div class="form-group">
										<label
											for="event-name"
											class="label"
											>Nome do
											Evento
											*</label
										>
										<input
											type="text"
											id="event-name"
											class="input"
											placeholder="Ex: Festival de Verão 2024"
											onclick="removerErro('event-name')"
										/>
										<span
											class="none erro"
											id="erro-name"
											>Nome é
											obrigatório!</span
										>
									</div>
									<div class="form-group">
										<label
											for="event-type"
											class="label"
											>Tipo de
											Evento</label
										>
										<select
											id="event-type"
											class="select"
										>
											<option
												value=""
											>
												Selecione
												o tipo
											</option>
											<option
												value="festival"
											>
												Festival
											</option>
											<option
												value="feira"
											>
												Feira
											</option>
											<option
												value="workshop"
											>
												Workshop
											</option>
											<option
												value="conferencia"
											>
												Conferência
											</option>
											<option
												value="outro"
											>
												Outro
											</option>
										</select>
									</div>
								</div>

								<div class="grid-2-cols gap-4">
									<div class="form-group">
										<label
											for="event-date"
											class="label"
											>Data do
											Evento
											*</label
										>
										<input
											type="date"
											id="event-date"
											class="input"
											onclick="removerErro('event-date')"
										/>
										<span
											class="none erro"
											id="erro-date"
											>Data é
											obrigatório!</span
										>
									</div>
									<div class="form-group">
										<label
											for="event-time"
											class="label"
											>Horário</label
										>
										<input
											type="time"
											id="event-time"
											class="input"
										/>
									</div>
								</div>

								<div class="form-group">
									<label
										for="event-location"
										class="label"
										>Local do Evento
										*</label
									>
									<input
										type="text"
										id="event-location"
										class="input"
										placeholder="Endereço completo"
										onclick="removerErro('event-location')"
									/>
									<span
										class="none erro"
										id="erro-location"
										>Local é
										obrigatório!</span
									>
								</div>

								<div class="grid-2-cols gap-4">
									<div class="form-group">
										<label
											for="attendees"
											class="label"
											>Público
											Estimado
											*</label
										>
										<input
											type="number"
											id="attendees"
											class="input"
											placeholder="Número de participantes"
											onclick="removerErro('attendees')"
										/>
										<span
											class="none erro"
											id="erro-publico"
											>Público é
											obrigatório!</span
										>
									</div>
									<div class="form-group">
										<label
											for="duration"
											class="label"
											>Duração
											(horas)</label
										>
										<input
											type="number"
											id="duration"
											class="input"
											placeholder="Ex: 8"
										/>
									</div>
								</div>

								<div class="form-group">
									<label
										for="description"
										class="label"
										>Descrição</label
									>
									<textarea
										id="description"
										class="textarea"
										placeholder="Descreva o evento, atividades e características especiais..."
										rows="3"
									></textarea>
								</div>
							</div>
						</div>
					</div>
					<div class="form-sidebar-section">
						<div class="card">
							<div class="card-header">
								<h2 class="card-title-lg">
									Resumo do Evento
								</h2>
							</div>
							<div class="card-content space-y-4">
								<div class="summary-item">
									<span
										class="summary-label"
										>Data:</span
									>
									<span
										class="summary-value"
										id="summaryDate"
									>Não definida</span>
								</div>
								<div class="summary-item">
									<span
										class="summary-label"
										>Participantes:</span
									>
									<span
										class="summary-value"
										id="summaryAttendees"
									>Não definido</span>
								</div>
								<div class="summary-item">
									<span
										class="summary-label"
										>Total de
										Resíduos:</span
									>
									<span
										class="summary-value text-green"
										id="summaryTotalWaste"
									>0kg</span>
								</div>
							</div>
						</div>

						<div class="card">
							<div class="card-header">
								<h2 class="card-title-lg">
									<img
										src="./../img/icon/clock.svg"
										alt="Relógio"
										class="icon icon-orange"
									/>
									Solicitação de Coleta
								</h2>
							</div>
							<div class="card-content space-y-4">
								<div class="form-group">
									<label
										for="collection-date"
										class="label"
										>Data Preferida para
										Coleta</label
									>
									<input
										type="date"
										id="collection-date"
										class="input"
									/>
								</div>
								<div class="form-group">
									<label
										for="collection-time"
										class="label"
										>Horário
										Preferido</label
									>
									<select
										id="collection-time"
										class="select"
									>
										<option
											value="morning"
										>
											Manhã (8h-12h)
										</option>
										<option
											value="afternoon"
										>
											Tarde
											(13h-17h)
										</option>
										<option
											value="evening"
										>
											Noite
											(18h-22h)
										</option>
										<option
											value="flexible"
										>
											Flexível
										</option>
									</select>
								</div>
								<div class="form-group">
									<label
										for="special-instructions"
										class="label"
										>Instruções
										Especiais</label
									>
									<textarea
										id="special-instructions"
										class="textarea"
										placeholder="Informações adicionais para a coleta..."
										rows="3"
									></textarea>
								</div>
							</div>
						</div>

						<div class="card card-blue-bg">
							<div class="card-content p-4">
								<h3 class="help-card-title">
									Precisa de ajuda?
								</h3>
								<p
									class="help-card-description"
								>
									Nossa equipe está pronta
									para ajudar você a
									planejar a gestão de
									resíduos do seu evento.
								</p>
								<button
									class="button button-outline-blue full-width"
								>
									Falar com Especialista
								</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<script src="./script/eventos-crud.js"></script>
		<script src="./../script/funcoes-main.js"></script>
		<script>
			let modoEdicao = false;
			let eventoEditandoId = null;

			// Inicializar página
			document.addEventListener('DOMContentLoaded', function() {
				verificarModoEdicao();
				configurarEventListeners();
				atualizarResumo();
			});

			function verificarModoEdicao() {
				const urlParams = new URLSearchParams(window.location.search);
				const editId = urlParams.get('edit');

				if (editId) {
					modoEdicao = true;
					eventoEditandoId = parseInt(editId);
					carregarDadosEvento(eventoEditandoId);

					document.querySelector('.header-title').textContent = 'Editar Evento';
					document.querySelector('.header-description').textContent = 'Edite as informações do evento';
					document.getElementById('publishEventBtn').innerHTML = `
						<img src="./../img/icon/save.svg" alt="Salvar" class="icon-sm icon-white" />
						Salvar Alterações
					`;
				}
			}

			function carregarDadosEvento(id) {
				const evento = eventosCRUD.getEventoPorId(id);
				if (!evento) {
					alert('Evento não encontrado!');
					window.location.href = './index.html';
					return;
				}

				document.getElementById('event-name').value = evento.nome || '';
				document.getElementById('event-type').value = evento.tipo || '';
				document.getElementById('event-date').value = evento.data || '';
				document.getElementById('event-time').value = evento.horario || '';
				document.getElementById('event-location').value = evento.local || '';
				document.getElementById('attendees').value = evento.publicoEstimado || '';
				document.getElementById('duration').value = evento.duracao || '';
				document.getElementById('description').value = evento.descricao || '';
				document.getElementById('collection-date').value = evento.dataColeta || '';
				document.getElementById('collection-time').value = evento.horarioColeta || '';
				document.getElementById('special-instructions').value = evento.instrucoes || '';
			}

			function configurarEventListeners() {
				const campos = ['event-name', 'event-date', 'attendees'];
				campos.forEach(campo => {
					const elemento = document.getElementById(campo);
					if (elemento) {
						elemento.addEventListener('input', atualizarResumo);
						elemento.addEventListener('change', atualizarResumo);
					}
				});
			}

			function atualizarResumo() {
				const nome = document.getElementById('event-name')?.value || '';
				const data = document.getElementById('event-date')?.value || '';
				const participantes = document.getElementById('attendees')?.value || '';

				const summaryDate = document.getElementById('summaryDate');
				const summaryAttendees = document.getElementById('summaryAttendees');
				const summaryTotalWaste = document.getElementById('summaryTotalWaste');

				if (summaryDate) {
					summaryDate.textContent = data ? formatarData(data) : 'Não definida';
				}

				if (summaryAttendees) {
					summaryAttendees.textContent = participantes ? `${participantes} pessoas` : 'Não definido';
				}

				if (summaryTotalWaste) {
					const residuosEstimados = participantes ? eventosCRUD.calcularResiduosEstimados(parseInt(participantes)) : 0;
					summaryTotalWaste.textContent = `${residuosEstimados}kg`;
				}
			}

			function formatarData(dataString) {
				const data = new Date(dataString);
				return data.toLocaleDateString('pt-BR');
			}

			function salvarEvento() {
				if (!validarFormulario()) {
					return;
				}

				const dadosEvento = coletarDadosFormulario();

				try {
					if (modoEdicao && eventoEditandoId) {
						const eventoAtualizado = eventosCRUD.atualizarEvento(eventoEditandoId, dadosEvento);
						if (eventoAtualizado) {
							alert('Evento atualizado com sucesso!');
							window.location.href = './index.html';
						} else {
							alert('Erro ao atualizar evento!');
						}
					} else {
						const novoEvento = eventosCRUD.criarEvento(dadosEvento);
						if (novoEvento) {
							alert('Evento criado com sucesso!');
							window.location.href = './index.html';
						} else {
							alert('Erro ao criar evento!');
						}
					}
				} catch (error) {
					console.error('Erro ao salvar evento:', error);
					alert('Erro ao salvar evento. Tente novamente.');
				}
			}

			function salvarRascunho() {
				const dadosEvento = coletarDadosFormulario();
				dadosEvento.status = 'rascunho';

				try {
					if (modoEdicao && eventoEditandoId) {
						eventosCRUD.atualizarEvento(eventoEditandoId, dadosEvento);
					} else {
						eventosCRUD.criarEvento(dadosEvento);
					}
					alert('Rascunho salvo com sucesso!');
				} catch (error) {
					console.error('Erro ao salvar rascunho:', error);
					alert('Erro ao salvar rascunho.');
				}
			}

			function coletarDadosFormulario() {
				return {
					nome: document.getElementById('event-name').value.trim(),
					tipo: document.getElementById('event-type').value,
					data: document.getElementById('event-date').value,
					horario: document.getElementById('event-time').value,
					local: document.getElementById('event-location').value.trim(),
					publicoEstimado: parseInt(document.getElementById('attendees').value) || 0,
					duracao: parseInt(document.getElementById('duration').value) || 0,
					descricao: document.getElementById('description').value.trim(),
					dataColeta: document.getElementById('collection-date').value,
					horarioColeta: document.getElementById('collection-time').value,
					instrucoes: document.getElementById('special-instructions').value.trim()
				};
			}

			function validarFormulario() {
				const camposObrigatorios = [
					{ id: 'event-name', erro: 'erro-name', mensagem: 'Nome é obrigatório!' },
					{ id: 'event-date', erro: 'erro-date', mensagem: 'Data é obrigatória!' },
					{ id: 'event-location', erro: 'erro-location', mensagem: 'Local é obrigatório!' },
					{ id: 'attendees', erro: 'erro-publico', mensagem: 'Público é obrigatório!' }
				];

				let temErro = false;

				camposObrigatorios.forEach(campo => {
					const erroElemento = document.getElementById(campo.erro);
					if (erroElemento) {
						erroElemento.classList.add('none');
					}
				});

				camposObrigatorios.forEach(campo => {
					const elemento = document.getElementById(campo.id);
					const valor = elemento?.value?.trim();

					if (!valor) {
						const erroElemento = document.getElementById(campo.erro);
						if (erroElemento) {
							erroElemento.textContent = campo.mensagem;
							erroElemento.classList.remove('none');
						}
						temErro = true;
					}
				});

				const publicoElemento = document.getElementById('attendees');
				const publico = parseInt(publicoElemento?.value);
				if (publicoElemento?.value && (isNaN(publico) || publico <= 0)) {
					const erroElemento = document.getElementById('erro-publico');
					if (erroElemento) {
						erroElemento.textContent = 'Público deve ser um número maior que zero!';
						erroElemento.classList.remove('none');
					}
					temErro = true;
				}

				return !temErro;
			}

			function removerErro(id) {
				let erroSpan;

				if (id === 'event-name') erroSpan = 'erro-name';
				if (id === 'event-date') erroSpan = 'erro-date';
				if (id === 'event-location') erroSpan = 'erro-location';
				if (id === 'attendees') erroSpan = 'erro-publico';

				const erroElemento = document.getElementById(erroSpan);
				if (erroElemento) {
					erroElemento.classList.add('none');
				}
			}

			// Sobrescrever função global para compatibilidade
			function salvar() {
				salvarEvento();
			}
		</script>
	</body>
</html>
